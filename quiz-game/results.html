<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quiz Results</title>
<style>
:root {
  --bg: #f7f8fb;
  --card: #fff;
  --ink: #0f172a;
  --muted: #6b7280;
  --accent: #2563eb;
  --ok: #22c55e;
  --bad: #ef4444;
  --ring: #e5e7eb;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
  color: var(--ink);
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100vh;
  overflow: hidden;
}

header {
  background: var(--card);
  width: 100%;
  max-width: 900px;
  box-shadow: 0 2px 10px rgba(0,0,0,.05);
  border-bottom: 1px solid var(--ring);
  border-radius: 0 0 16px 16px;
  padding: 1rem 1.2rem;
  position: sticky;
  top: 0;
  z-index: 10;
}

header h1 {
  text-align: center;
  font-size: 1.5rem;
  color: var(--accent);
}

main {
  flex: 1;
  width: 100%;
  max-width: 900px;
  overflow-y: auto;
  padding: 1rem;
  scrollbar-width: thin;
  scrollbar-color: #d1d5db transparent;
}

.card {
  background: var(--card);
  border: 1px solid var(--ring);
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,.04);
  padding: 1.2rem;
}

#loading {
  text-align: center;
  font-size: 1.1rem;
  color: var(--muted);
  margin-top: 2rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 16px;
  overflow: hidden;
}

th, td {
  padding: 0.9rem 1rem;
  text-align: left;
  border-bottom: 1px solid var(--ring);
}

th {
  background: #f3f4f6;
  color: var(--muted);
  font-weight: 600;
}

td img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  border-radius: 10px;
  border: 1px solid var(--ring);
  background: #f9fafb;
}

.percent {
  font-weight: bold;
  text-align: center;
}
.low { color: var(--bad); }
.mid { color: #f59e0b; }
.high { color: var(--ok); }

tr:hover {
  background: #f9fafb;
}

tfoot td {
  background: #f3f4f6;
  font-weight: bold;
}

::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

@media (max-width: 600px) {
  header h1 { font-size: 1.2rem; }
  td img { width: 60px; height: 60px; }
  th, td { padding: 0.6rem 0.7rem; }
}
</style>
</head>
<body>
<header>
  <h1>Quiz Results</h1>
</header>

<main>
  <div id="loading">Loading results...</div>
  <div class="card" id="resultsWrap" hidden>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Question</th>
          <th>Correct / Total</th>
          <th>Success %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script type="module">
import { qsets } from "./data.js"; // adjust if needed

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5ZL659ucVPHIl8XWI3PvIP16k7xwFgyxpcT5av3NBT6lrNPWSA_NSrkHOpa67NY3MgU4CK5O7JxLF/pub?gid=1527734891&single=true&output=csv";

function getParams() {
  const p = new URLSearchParams(location.search);
  return {
    quiz: p.get('quiz'),
    names: p.get('name') ? p.get('name').split(',').map(n => n.trim()) : [],
    after: p.get('after') ? new Date(p.get('after')) : null
  };
}

function parseCSV(text) {
  const [headerLine, ...lines] = text.trim().split("\n");
  const headers = headerLine.split(",").map(h => h.trim());
  return lines.map(line => {
    const cells = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(s => s.replace(/^"|"$/g, "")) || [];
    const row = {};
    headers.forEach((h, i) => row[h] = cells[i] || "");
    return row;
  });
}

async function loadResults() {
  const { quiz, names, after } = getParams();
  const loadingEl = document.getElementById("loading");
  const wrap = document.getElementById("resultsWrap");
  const table = document.getElementById("resultsTable");
  if (!quiz) {
    loadingEl.textContent = "Add ?quiz=0 to the URL.";
    return;
  }

  try {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);

    const relevant = rows.filter(r => r.quiz == quiz);
    const filtered = relevant.filter(r => {
      const t = new Date(r.Timestamp);
      const nOK = names.length ? names.includes(r.name) : true;
      const dOK = after ? t > after : true;
      return nOK && dOK;
    });

    if (!filtered.length) {
      loadingEl.textContent = "No results found.";
      return;
    }

    const stats = {};

    // Step 1: Aggregate correct / total attempts per question
    for (const r of filtered) {
      const qNum = parseInt(r.question, 10);
      if (!stats[qNum]) stats[qNum] = { correct: 0, total: 0 };
      stats[qNum].total++;
      if (r.correct && r.correct.toLowerCase().trim() === "correct") stats[qNum].correct++;
    }

    // Step 2: Pull quiz data by number (e.g. qset6)
    const quizSet = qsets[quiz];
    if (!quizSet) {
      loadingEl.textContent = `Quiz set qset${quiz} not found.`;
      return;
    }

    // Step 3: Merge results with all questions (including unattempted)
    const results = quizSet.images.map((img, i) => {
     const s = stats[i] || { correct: 0, total: 0 };
     const rate = s.total ? Math.round((s.correct / s.total) * 100) : null;
      return {
        index: i,
        img,
        correct: s.correct,
        total: s.total,
        rate
      };
    }).sort((a, b) => (a.rate ?? -1) - (b.rate ?? -1));

    // Step 4: Render results table
    table.innerHTML = `
      <tr>
        <th>Question</th>
        <th>Result</th>
      </tr>
      ${results.map(r => `
        <tr>
          <td><img src="${r.img}" alt="Question ${r.index}" style="width:80px;height:80px;object-fit:contain;"></td>
          <td>${r.total ? `${r.correct}/${r.total} (${r.rate}%)` : '-'}</td>
        </tr>
      `).join('')}
    `;


      } catch (err) {
        console.error(err);
        loadingEl.textContent = "Error loading results.";
      }
      
      wrap.hidden = false;
      loadingEl.style.display = "none";

    }


loadResults();
</script>
</body>
</html>
